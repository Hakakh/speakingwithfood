index.html
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Luy·ªán N√≥i Ti·∫øng Anh - T·ª´ V·ª±ng ƒê·ªì ƒÇn</title>
    <style>
        /* Basic styling for the body and container */
        body {
            font-family: Arial, sans-serif; /* S·ª≠ d·ª•ng Arial ho·∫∑c font sans-serif chung */
            background: #f0f8ff; /* N·ªÅn xanh d∆∞∆°ng nh·∫°t */
            padding: 20px;
            line-height: 1.6; /* C·∫£i thi·ªán kh·∫£ nƒÉng ƒë·ªçc */
            color: #333; /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
            display: flex; /* S·ª≠ d·ª•ng flexbox ƒë·ªÉ cƒÉn gi·ªØa */
            justify-content: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
            align-items: flex-start; /* CƒÉn tr√™n c√πng theo chi·ªÅu d·ªçc, cho ph√©p cu·ªôn n·∫øu n·ªôi dung d√†i */
            min-height: 100vh; /* Chi·ªÅu cao t·ªëi thi·ªÉu b·∫±ng chi·ªÅu cao viewport */
            margin: 0; /* Lo·∫°i b·ªè margin m·∫∑c ƒë·ªãnh c·ªßa body */
        }

        /* Container for the main content */
        .container {
            max-width: 600px; /* Chi·ªÅu r·ªông t·ªëi ƒëa */
            width: 100%; /* ƒê·∫£m b·∫£o container chi·∫øm to√†n b·ªô chi·ªÅu r·ªông n·∫øu m√†n h√¨nh nh·ªè h∆°n max-width */
            margin: 20px auto; /* CƒÉn gi·ªØa container v√† th√™m l·ªÅ d·ªçc */
            background: #fff; /* N·ªÅn tr·∫Øng cho khu v·ª±c n·ªôi dung */
            padding: 20px;
            border-radius: 10px; /* Bo g√≥c */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* ƒê·ªï b√≥ng nh·∫π */
            text-align: center; /* CƒÉn gi·ªØa ch·ªØ trong container */
        }

        /* Heading style */
        h1 {
            text-align: center;
            color: #0056b3; /* M√†u xanh d∆∞∆°ng ƒë·∫≠m h∆°n cho ti√™u ƒë·ªÅ */
            margin-bottom: 20px;
        }

        /* Style for the question area */
        .question {
            margin: 20px 0;
            font-size: 1.2em; /* Ch·ªØ to h∆°n m·ªôt ch√∫t cho c√¢u h·ªèi */
            font-weight: bold;
            color: #555; /* M√†u x√°m cho ch·ªØ c√¢u h·ªèi */
        }

        /* Style for the target sentence instruction */
        .target-sentence {
            margin-top: 10px;
            font-size: 1em;
            color: #007bff; /* M√†u xanh d∆∞∆°ng cho h∆∞·ªõng d·∫´n */
            font-style: italic;
        }

        /* Style for the answer display box */
        .answer-box {
            background: #eef; /* N·ªÅn xanh d∆∞∆°ng r·∫•t nh·∫°t */
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            min-height: 1.5em; /* ƒê·∫£m b·∫£o box c√≥ chi·ªÅu cao nh·∫•t ƒë·ªãnh ngay c·∫£ khi tr·ªëng */
            text-align: left; /* CƒÉn ch·ªØ c√¢u tr·∫£ l·ªùi v·ªÅ b√™n tr√°i */
            word-wrap: break-word; /* Ng·∫Øt t·ª´ d√†i */
            border: 1px solid #cce; /* Vi·ªÅn nh·∫π */
        }

        /* Style for buttons */
        button {
            margin: 10px 5px; /* Th√™m l·ªÅ xung quanh n√∫t */
            padding: 12px 20px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #007bff; /* M√†u xanh d∆∞∆°ng ch√≠nh */
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u m∆∞·ª£t m√† v√† hi·ªáu ·ª©ng nh·∫•n n√∫t */
        }

        button:active {
            transform: scale(0.98); /* Hi·ªáu ·ª©ng n√∫t ƒë∆∞·ª£c nh·∫•n xu·ªëng */
        }

        /* Button hover effect */
        button:hover {
            background: #0056b3; /* M√†u xanh d∆∞∆°ng ƒë·∫≠m h∆°n khi hover */
        }

        /* Disabled button style */
        button:disabled {
            background: #cccccc; /* M√†u x√°m cho n√∫t b·ªã v√¥ hi·ªáu h√≥a */
            cursor: not-allowed;
        }

        /* Style for the image */
        .image {
            display: none; /* Ban ƒë·∫ßu ·∫©n */
            width: 100%; /* L√†m cho h√¨nh ·∫£nh responsive */
            max-width: 350px; /* Chi·ªÅu r·ªông t·ªëi ƒëa cho h√¨nh ·∫£nh */
            height: auto; /* Duy tr√¨ t·ª∑ l·ªá khung h√¨nh */
            margin: 20px auto; /* CƒÉn gi·ªØa h√¨nh ·∫£nh v√† th√™m l·ªÅ d·ªçc */
            border-radius: 8px; /* Bo g√≥c cho h√¨nh ·∫£nh */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* ƒê·ªï b√≥ng nh·∫π cho h√¨nh ·∫£nh */
            border: 1px solid #ddd; /* Vi·ªÅn nh·∫π cho h√¨nh ·∫£nh */
        }

        /* Style for feedback messages */
        .result {
            background: #e0ffe0; /* N·ªÅn xanh l√° nh·∫°t */
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            text-align: left;
            border: 1px solid #a3e0a3; /* Vi·ªÅn xanh l√° */
            font-weight: bold;
        }

        /* Style for the result display area */
        .results-display {
            background: #fff8e1; /* N·ªÅn v√†ng r·∫•t nh·∫°t */
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: left;
            border: 1px solid #ffecb3; /* Vi·ªÅn v√†ng nh·∫°t */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .results-display h3 {
            color: #0056b3; /* M√†u ti√™u ƒë·ªÅ gi·ªëng h1 */
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .results-display p {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #eee; /* Ph√¢n c√°ch c√°c m·ª•c k·∫øt qu·∫£ */
        }
        .results-display p:last-child {
            border-bottom: none; /* Kh√¥ng c√≥ ƒë∆∞·ªùng vi·ªÅn cho m·ª•c cu·ªëi c√πng */
        }


        .results-display strong {
            color: #007bff;
        }

        .results-display em {
            color: #555;
        }

        .results-display button { /* N√∫t chia s·∫ª trong ph·∫ßn k·∫øt qu·∫£ */
            display: block;
            margin: 20px auto 10px auto; /* CƒÉn gi·ªØa n√∫t */
            background-color: #28a745; /* M√†u xanh l√° c√¢y cho n√∫t chia s·∫ª */
        }
        .results-display button:hover {
            background-color: #218838; /* M√†u xanh l√° c√¢y ƒë·∫≠m h∆°n khi hover */
        }


        #copyFeedback {
            margin-top: 15px;
            font-size: 0.95em;
            color: #155724; /* M√†u xanh ƒë·∫≠m cho th√¥ng b√°o copy */
            background-color: #d4edda; /* N·ªÅn xanh nh·∫°t */
            border: 1px solid #c3e6cb; /* Vi·ªÅn xanh */
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        #copyFeedback a {
            color: #0056b3;
            font-weight: bold;
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Luy·ªán N√≥i Ti·∫øng Anh - T·ª´ V·ª±ng ƒê·ªì ƒÇn</h1>
        <div id="questionArea" class="question">B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ nghe c√¢u h·ªèi.</div>
        <img id="questionImage" class="image" src="https://placehold.co/400x300/E0E0E0/B0B0B0?text=H√¨nh+·∫£nh+c√¢u+h·ªèi" alt="H√¨nh ·∫£nh c√¢u h·ªèi" style="display: none;" onerror="this.src='https://placehold.co/400x300/E0E0E0/B0B0B0?text=L·ªói+t·∫£i+·∫£nh';" />
        <div id="targetSentenceArea" class="target-sentence" style="display: none;"></div>
        <div>
            <button onclick="speakQuestion()" id="startButton">üîä B·∫Øt ƒë·∫ßu</button>
            <button onclick="startRecognition()" id="answerButton">üé§ Tr·∫£ l·ªùi</button>
        </div>
        <div id="transcript" class="answer-box"></div>
        <div id="feedback" class="result" style="display: none;"></div>
        <div>
            <button onclick="nextQuestion()" id="nextButton">‚û°Ô∏è C√¢u h·ªèi ti·∫øp theo</button>
            <button onclick="displayResults()" id="viewResultsButton">üìä Xem k·∫øt qu·∫£</button>
        </div>
        <div id="resultsDisplayArea" class="results-display" style="display: none;"></div>
    </div>

    <script>
        // M·∫£ng c√¢u h·ªèi, h√¨nh ·∫£nh, t√™n ƒë·ªì ƒÉn v√† c√¢u tr·∫£ l·ªùi ƒë√∫ng
        const questions = [
            // C√¢u h·ªèi 1: Kh√¥ng c√≥ h√¨nh ·∫£nh, kh√¥ng c√≥ foodName, kh√¥ng c√≥ correctAnswer c·ª• th·ªÉ
            { question: "What's your name?", image: "", foodName: null, correctAnswer: null },
            // C√°c c√¢u h·ªèi v·ªÅ ƒë·ªì ƒÉn - ƒê√£ thay ƒë·ªïi c√¢u h·ªèi v√† c√¢u tr·∫£ l·ªùi ƒë√∫ng
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504141034271092312.jpg", foodName: "apples", correctAnswer: "I like to eat apples." }, // H√¨nh ·∫£nh: T√°o
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504141033314127562.jpg", foodName: "bananas", correctAnswer: "I like to eat bananas." }, // H√¨nh ·∫£nh: Chu·ªëi
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504141033506151991.jpg", foodName: "oranges", correctAnswer: "I like to eat oranges." }, // H√¨nh ·∫£nh: cam
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181532276827489.jpg", foodName: "strawberries", correctAnswer: "I like to eat strawberries." }, // H√¨nh ·∫£nh: D√¢u t√¢y
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181533175517785.jpg", foodName: "watermelon", correctAnswer: "I like to eat watermelon." }, // H√¨nh ·∫£nh: D∆∞a h·∫•u
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181534478555845.jpg", foodName: "mangoes", correctAnswer: "I like to eat mangoes." }, // H√¨nh ·∫£nh: Xo√†i
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504141034065919288.jpg", foodName: "pineapples", correctAnswer: "I like to eat pineapples." }, // H√¨nh ·∫£nh: D·ª©a
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181537008328849.jpg", foodName: "cherries", correctAnswer: "I like to eat cherries." }, // H√¨nh ·∫£nh: Anh ƒë√†o
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181539464041236.jpg", foodName: "broccoli", correctAnswer: "I like to eat broccoli." }, // H√¨nh ·∫£nh: B√¥ng c·∫£i xanh
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181542372646542.jpg", foodName: "carrots", correctAnswer: "I like to eat carrots." }, // H√¨nh ·∫£nh: C√† r·ªët
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181544363516825.jpg", foodName: "corn", correctAnswer: "I like to eat corn." }, // H√¨nh ·∫£nh: Ng√¥
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181610006728723.jpg", foodName: "rice", correctAnswer: "I like to eat rice." }, // H√¨nh ·∫£nh: G·∫°o
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181602176468296.jpg", foodName: "noodles", correctAnswer: "I like to eat noodles." }, // H√¨nh ·∫£nh: M√¨
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181602312331406.jpg", foodName: "chicken", correctAnswer: "I like to eat chicken." }, // H√¨nh ·∫£nh: Th·ªãt g√†
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181603211314197.jpg", foodName: "beef", correctAnswer: "I like to eat beef." }, // H√¨nh ·∫£nh: Th·ªãt b√≤
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181603346252980.jpg", foodName: "fish", correctAnswer: "I like to eat fish." }, // H√¨nh ·∫£nh: C√°
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181603506586124.jpg", foodName: "eggs", correctAnswer: "I like to eat eggs." }, // H√¨nh ·∫£nh: Tr·ª©ng
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181604021443793.jpg", foodName: "pizza", correctAnswer: "I like to eat pizza." }, // H√¨nh ·∫£nh: B√°nh pizza
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181604489459921.jpg", foodName: "a hamburger", correctAnswer: "I like to eat a hamburger." }, // H√¨nh ·∫£nh: B√°nh hamburger
            { question: "What do you like to eat?", image: "https://yourhomework.net/yhw/f/yhw-voca/2025/04/1/202504181607048976434.jpg", foodName: "ice cream", correctAnswer: "I like to eat ice cream." }  // H√¨nh ·∫£nh: Kem
        ];

        let currentIndex = 0; // Theo d√µi ch·ªâ s·ªë c√¢u h·ªèi hi·ªán t·∫°i
        let studentAnswers = new Array(questions.length).fill(""); // L∆∞u tr·ªØ c√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh

        // DOM Elements
        const questionArea = document.getElementById("questionArea");
        const questionImage = document.getElementById("questionImage");
        const targetSentenceArea = document.getElementById("targetSentenceArea");
        const transcriptDiv = document.getElementById("transcript");
        const feedbackDiv = document.getElementById("feedback");
        const resultsDisplayArea = document.getElementById("resultsDisplayArea");
        const startButton = document.getElementById("startButton");
        const answerButton = document.getElementById("answerButton");
        const nextButton = document.getElementById("nextButton");
        const viewResultsButton = document.getElementById("viewResultsButton");


        // Ki·ªÉm tra h·ªó tr·ª£ SpeechRecognition API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US'; // ƒê·∫∑t ng√¥n ng·ªØ nh·∫≠n d·∫°ng l√† ti·∫øng Anh
            recognition.continuous = false; // Ch·ªâ ghi l·∫°i m·ªôt c√¢u n√≥i duy nh·∫•t
            recognition.interimResults = false; // Ch·ªâ tr·∫£ v·ªÅ k·∫øt qu·∫£ cu·ªëi c√πng

            // X·ª≠ l√Ω s·ª± ki·ªán khi c√≥ k·∫øt qu·∫£ nh·∫≠n d·∫°ng
            recognition.onresult = function (event) {
                const transcript = event.results.length > 0 ? event.results[0][0].transcript.trim() : '';
                transcriptDiv.textContent = `C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: ${transcript}`;
                studentAnswers[currentIndex] = transcript; // L∆∞u c√¢u tr·∫£ l·ªùi
                provideFeedback(transcript); // Cung c·∫•p ph·∫£n h·ªìi
                answerButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t tr·∫£ l·ªùi sau khi c√≥ k·∫øt qu·∫£
            };

            // X·ª≠ l√Ω s·ª± ki·ªán khi c√≥ l·ªói nh·∫≠n d·∫°ng
            recognition.onerror = function(event) {
                console.error("L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:", event.error);
                let errorMessage = `L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i: ${event.error}`;
                if (event.error === 'no-speech') {
                    errorMessage = "Kh√¥ng ph√°t hi·ªán th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "L·ªói thu √¢m thanh. Ki·ªÉm tra micro c·ªßa b·∫°n.";
                } else if (event.error === 'not-allowed') {
                    errorMessage = "Quy·ªÅn truy c·∫≠p micro b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn.";
                }
                feedbackDiv.textContent = errorMessage;
                feedbackDiv.style.display = 'block';
                speakText("C√≥ l·ªói x·∫£y ra, b·∫°n h√£y th·ª≠ l·∫°i.", 'vi-VN');
                answerButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t tr·∫£ l·ªùi
            };

            recognition.onstart = function() {
                answerButton.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t tr·∫£ l·ªùi trong khi ƒëang nghe
                transcriptDiv.textContent = "ƒêang nghe...";
            };

            recognition.onend = function() {
                answerButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t tr·∫£ l·ªùi khi k·∫øt th√∫c
                    if (transcriptDiv.textContent === "ƒêang nghe...") { // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ n√†o ƒë∆∞·ª£c x·ª≠ l√Ω (v√≠ d·ª•: onresult kh√¥ng k√≠ch ho·∫°t)
                        // C√≥ th·ªÉ kh√¥ng c·∫ßn thi·∫øt n·∫øu onresult ho·∫∑c onerror lu√¥n ƒë∆∞·ª£c g·ªçi
                    }
            };

        } else {
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng h·ªó tr·ª£ Speech Recognition
            console.warn("API Nh·∫≠n d·∫°ng gi·ªçng n√≥i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ trong tr√¨nh duy·ªát n√†y.");
            if (answerButton) {
                answerButton.disabled = true;
                answerButton.textContent = "üé§ API kh√¥ng h·ªó tr·ª£";
            }
            questionArea.textContent = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i. Vui l√≤ng th·ª≠ tr√¨nh duy·ªát kh√°c.";
        }

        // H√†m ph√°t √¢m vƒÉn b·∫£n
        function speakText(text, lang = 'en-US') {
            // D·ª´ng b·∫•t k·ª≥ ph√°t √¢m n√†o ƒëang di·ªÖn ra
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        // H√†m ƒë·ªçc c√¢u h·ªèi hi·ªán t·∫°i
        function speakQuestion() {
            if (currentIndex >= questions.length) {
                questionArea.textContent = "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!";
                questionImage.style.display = 'none';
                targetSentenceArea.style.display = 'none';
                disableButtonsOnComplete();
                displayResults(); // T·ª± ƒë·ªông hi·ªÉn th·ªã k·∫øt qu·∫£ khi ho√†n th√†nh
                return;
            }

            const currentQuestionData = questions[currentIndex];
            speakText(currentQuestionData.question, 'en-US'); // ƒê·ªçc c√¢u h·ªèi b·∫±ng ti·∫øng Anh
            questionArea.textContent = `C√¢u h·ªèi ${currentIndex + 1}/${questions.length}: ${currentQuestionData.question}`;

            targetSentenceArea.style.display = 'none'; // ·∫®n c√¢u m·ª•c ti√™u tr∆∞·ªõc
            if (currentQuestionData.image && currentQuestionData.image.trim() !== "") {
                questionImage.src = currentQuestionData.image;
                questionImage.style.display = 'block';
                if (currentQuestionData.foodName) {
                    // C·∫≠p nh·∫≠t h∆∞·ªõng d·∫´n m·ª•c ti√™u
                    targetSentenceArea.textContent = `H√£y ƒë·ªçc: I like to eat ${currentQuestionData.foodName}.`;
                    targetSentenceArea.style.display = 'block';
                }
            } else {
                questionImage.style.display = 'none';
            }

            transcriptDiv.textContent = ""; // X√≥a b·∫£n ghi c√¢u tr·∫£ l·ªùi c≈©
            feedbackDiv.textContent = ""; // X√≥a ph·∫£n h·ªìi c≈©
            feedbackDiv.style.display = 'none';
            resultsDisplayArea.style.display = 'none'; // ·∫®n k·∫øt qu·∫£ khi b·∫Øt ƒë·∫ßu c√¢u h·ªèi m·ªõi
            resultsDisplayArea.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©

            // K√≠ch ho·∫°t l·∫°i c√°c n√∫t n·∫øu ch√∫ng b·ªã v√¥ hi·ªáu h√≥a tr∆∞·ªõc ƒë√≥ (tr·ª´ khi ƒë√£ ho√†n th√†nh t·∫•t c·∫£)
            startButton.disabled = false;
            answerButton.disabled = !SpeechRecognition; // Ch·ªâ k√≠ch ho·∫°t n·∫øu API ƒë∆∞·ª£c h·ªó tr·ª£
            nextButton.disabled = false;
            viewResultsButton.disabled = false;
        }

        // H√†m b·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng gi·ªçng n√≥i
        function startRecognition() {
            if (currentIndex >= questions.length) {
                transcriptDiv.textContent = "B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√¢u h·ªèi.";
                return;
            }
            if (recognition) {
                try {
                    // feedbackDiv.textContent = ""; // X√≥a ph·∫£n h·ªìi c≈© tr∆∞·ªõc khi nghe
                    // feedbackDiv.style.display = 'none';
                    recognition.start(); // B·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng
                } catch (e) {
                    console.error("L·ªói khi b·∫Øt ƒë·∫ßu nh·∫≠n d·∫°ng:", e);
                    transcriptDiv.textContent = "Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông micro.";
                    if (e.name === 'NotAllowedError') {
                        transcriptDiv.textContent = "B·∫°n c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p micro.";
                    } else if (e.name === 'InvalidStateError') {
                        // Th∆∞·ªùng x·∫£y ra n·∫øu g·ªçi start() khi ƒëang nh·∫≠n d·∫°ng
                        console.warn("Recognition ƒëang ch·∫°y, kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu l·∫°i ngay.");
                        // C√≥ th·ªÉ kh√¥ng c·∫ßn l√†m g√¨ ·ªü ƒë√¢y n·∫øu onend x·ª≠ l√Ω vi·ªác k√≠ch ho·∫°t l·∫°i n√∫t
                    }
                    answerButton.disabled = false; // ƒê·∫£m b·∫£o n√∫t ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i n·∫øu c√≥ l·ªói t·ª©c th√¨
                }
            } else {
                transcriptDiv.textContent = "Nh·∫≠n d·∫°ng gi·ªçng n√≥i kh√¥ng kh·∫£ d·ª•ng.";
            }
        }

        // H√†m cung c·∫•p ph·∫£n h·ªìi v·ªÅ c√¢u tr·∫£ l·ªùi
        function provideFeedback(answer) {
            feedbackDiv.style.display = 'block'; // Hi·ªÉn th·ªã √¥ ph·∫£n h·ªìi
            const currentQuestionData = questions[currentIndex];
            let comment = "";
            let speakFeedbackText = ""; // VƒÉn b·∫£n ph·∫£n h·ªìi b·∫±ng gi·ªçng n√≥i (ti·∫øng Vi·ªát)

            if (!answer || answer.trim() === "") {
                comment = "‚ö†Ô∏è Kh√¥ng ph√°t hi·ªán th·∫•y c√¢u tr·∫£ l·ªùi. B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
                speakFeedbackText = "B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
            } else if (currentQuestionData.correctAnswer) {
                // Chu·∫©n h√≥a c√¢u tr·∫£ l·ªùi: b·ªè d·∫•u c√¢u, chuy·ªÉn sang ch·ªØ th∆∞·ªùng
                const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                const normalizedAnswer = normalize(answer);
                const normalizedCorrectAnswer = normalize(currentQuestionData.correctAnswer);

                if (normalizedAnswer === normalizedCorrectAnswer) {
                    comment = "‚úÖ B·∫°n n√≥i r·∫•t t·ªët!";
                    speakFeedbackText = "B·∫°n n√≥i r·∫•t t·ªët!";
                } else {
                    comment = `‚ùå Ch∆∞a ƒë√∫ng l·∫Øm. B·∫°n h√£y th·ª≠ ƒë·ªçc l·∫°i nh√©! (C√¢u ƒë√∫ng n√™n l√†: "${currentQuestionData.correctAnswer}")`;
                    speakFeedbackText = "B·∫°n h√£y ƒë·ªçc l·∫°i nh√©!";
                }
            } else {
                // ƒê·ªëi v·ªõi c√¢u h·ªèi kh√¥ng c√≥ ƒë√°p √°n c·ª• th·ªÉ (v√≠ d·ª•: "What's your name?")
                comment = "‚úÖ ƒê√£ ghi l·∫°i c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.";
                // Kh√¥ng c·∫ßn ph·∫£n h·ªìi gi·ªçng n√≥i ƒë·∫∑c bi·ªát ·ªü ƒë√¢y, ho·∫∑c c√≥ th·ªÉ th√™m n·∫øu mu·ªën
            }
            feedbackDiv.textContent = comment;
            if (speakFeedbackText) {
                speakText(speakFeedbackText, 'vi-VN');
            }
        }

        // H√†m chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo
        function nextQuestion() {
            currentIndex++;
            if (currentIndex < questions.length) {
                speakQuestion();
            } else {
                questionArea.textContent = "üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!";
                questionImage.style.display = 'none';
                targetSentenceArea.style.display = 'none';
                transcriptDiv.textContent = "";
                feedbackDiv.style.display = 'none';
                disableButtonsOnComplete();
                displayResults(); // T·ª± ƒë·ªông hi·ªÉn th·ªã k·∫øt qu·∫£
            }
        }

        // H√†m v√¥ hi·ªáu h√≥a c√°c n√∫t khi ho√†n th√†nh
        function disableButtonsOnComplete() {
            startButton.disabled = true;
            answerButton.disabled = true;
            nextButton.disabled = true;
            // viewResultsButton v·∫´n c√≥ th·ªÉ ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫•n l·∫°i n·∫øu mu·ªën
        }

        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ tr√™n trang
        function displayResults() {
            resultsDisplayArea.innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©

            let resultHTML = "<h3>B·∫£ng K·∫øt Qu·∫£ Luy·ªán N√≥i</h3>";
            const list = questions.map((q, i) => {
                const userAnswer = studentAnswers[i] || "(ch∆∞a tr·∫£ l·ªùi)";
                let correctness = "";
                if (q.correctAnswer) {
                    const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                    const normalizedUserAnswer = normalize(userAnswer);
                    const normalizedCorrectAnswer = normalize(q.correctAnswer);

                    if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)" && normalizedUserAnswer === normalizedCorrectAnswer) {
                        correctness = " <span style='color: green; font-weight:bold;'>‚úî R·∫•t t·ªët!</span>";
                    } else if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)") {
                        correctness = ` <span style='color: red; font-weight:bold;'>‚úò C·∫ßn xem l·∫°i</span> (C√¢u ƒë√∫ng: <em>"${q.correctAnswer}"</em>)`;
                    } else {
                        correctness = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                    }
                } else if (userAnswer === "(ch∆∞a tr·∫£ l·ªùi)") {
                        correctness = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                }


                return `<p><strong>C√¢u h·ªèi ${i + 1}:</strong> ${q.question}<br/>
                            <em>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</em> ${userAnswer}${correctness}</p>`;
            }).join('');

            resultHTML += list;
            resultHTML += `<button onclick="shareGeneratedResults()">üì§ Chia s·∫ª k·∫øt qu·∫£ n√†y</button>`;
            resultHTML += `<div id="copyFeedback" style="display:none;"></div>`; // ·∫®n ban ƒë·∫ßu

            resultsDisplayArea.innerHTML = resultHTML;
            resultsDisplayArea.style.display = 'block';
            resultsDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // H√†m t·∫°o n·ªôi dung HTML ƒë·ªÉ chia s·∫ª v√† sao ch√©p li√™n k·∫øt
        function shareGeneratedResults() {
            const listItems = questions.map((q, i) => {
                const userAnswer = studentAnswers[i] || "(ch∆∞a tr·∫£ l·ªùi)";
                let correctnessInfo = "";
                    if (q.correctAnswer) {
                        const normalize = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "").replace(/\s+/g, ' ').trim();
                        const normalizedUserAnswer = normalize(userAnswer);
                        const normalizedCorrectAnswer = normalize(q.correctAnswer);
                        if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)" && normalizedUserAnswer === normalizedCorrectAnswer) {
                            correctnessInfo = " <span style='color: green; font-weight:bold;'>(R·∫•t t·ªët!)</span>";
                        } else if (userAnswer !== "(ch∆∞a tr·∫£ l·ªùi)") {
                            correctnessInfo = ` <span style='color: red; font-weight:bold;'>(C·∫ßn xem l·∫°i)</span> - ƒê√°p √°n ƒë√∫ng: <em>"${q.correctAnswer}"</em>`;
                        } else {
                            correctnessInfo = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                        }
                    } else if (userAnswer === "(ch∆∞a tr·∫£ l·ªùi)") {
                            correctnessInfo = " <span style='color: orange;'>(ch∆∞a tr·∫£ l·ªùi)</span>";
                    }


                return `
                    <div style="margin-bottom: 15px; padding-bottom:10px; border-bottom: 1px solid #eee;">
                        <p style="font-weight: bold; color: #0056b3; margin-bottom: 5px;">C√¢u h·ªèi ${i + 1}: ${q.question}</p>
                        ${q.image ? `<p style="margin-top:5px; margin-bottom:5px;"><img src="${q.image}" alt="H√¨nh ·∫£nh cho c√¢u h·ªèi ${i+1}" style="max-width: 200px; max-height:150px; height: auto; border-radius: 5px; border: 1px solid #ddd;" onerror="this.style.display='none'" /></p>` : ''}
                        <p style="margin-top:5px;"><em>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</em> ${userAnswer}${correctnessInfo}</p>
                    </div>`;
            }).join('');

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>K·∫øt qu·∫£ Luy·ªán N√≥i Ti·∫øng Anh c·ªßa B√©</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; line-height: 1.6; }
                        .container-result { max-width: 700px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
                        h2 { color: #0056b3; text-align: center; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 25px; }
                        p { margin-bottom: 8px; }
                        em { font-style: italic; color: #555; }
                    </style>
                </head>
                <body>
                    <div class="container-result">
                        <h2>K·∫øt qu·∫£ Luy·ªán N√≥i Ti·∫øng Anh - T·ª´ V·ª±ng ƒê·ªì ƒÇn</h2>
                        ${listItems}
                        <p style="text-align:center; margin-top:25px; font-size:0.9em; color: #777;">K·∫øt qu·∫£ ƒë∆∞·ª£c t·∫°o v√†o l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
                    </div>
                </body>
                </html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const copyFeedbackDiv = document.getElementById("copyFeedback");
            copyFeedbackDiv.style.display = 'block'; // Hi·ªÉn th·ªã th√¥ng b√°o copy

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    copyFeedbackDiv.innerHTML = `üîó Link k·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c sao ch√©p! B·∫°n c√≥ th·ªÉ d√°n (Ctrl+V ho·∫∑c Command+V) ƒë·ªÉ chia s·∫ª. Ho·∫∑c <a href="${url}" target="_blank" rel="noopener noreferrer">xem k·∫øt qu·∫£ t·∫°i ƒë√¢y</a>.`;
                }).catch(err => {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p link t·ª± ƒë·ªông: ', err);
                    copyFeedbackDiv.innerHTML = `Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p link. Vui l√≤ng sao ch√©p th·ªß c√¥ng: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
                });
            } else {
                copyFeedbackDiv.innerHTML = `Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p link sau ƒë·ªÉ chia s·∫ª: <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            }
            // M·ªü link trong tab m·ªõi ƒë·ªÉ ng∆∞·ªùi d√πng xem tr∆∞·ªõc
            window.open(url, '_blank');
        }

        // Kh·ªüi ƒë·ªông c√¢u h·ªèi ƒë·∫ßu ti√™n khi t·∫£i trang
        // Ho·∫∑c c√≥ th·ªÉ ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫•n "B·∫Øt ƒë·∫ßu"
        // window.onload = speakQuestion; // B·ªè comment d√≤ng n√†y n·∫øu mu·ªën t·ª± ƒë·ªông b·∫Øt ƒë·∫ßu
    </script>
</body>
</html>
